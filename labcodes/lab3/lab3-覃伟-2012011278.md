# lab3 report 计22班 覃伟 2012011278

## 练习1 给未被映射的地址映射上物理页（需要编程）
完成do_pgfault（mm/vmm.c）函数，给未被映射的地址映射上物理页。
```
1. 先通过get_pte函数得到访问的地址对应的pte，传入的第三个参数1代表pte不存在就创建；      
2. 如果得到的pte内容全为0，表明还没有分配物理页，那么调用pgdir_alloc_page函数分配页，并将线性地址和逻辑地址建立映射关系pde；     
3. 得到的pte不为0，表明已经分配了物理页，但是不在内存中而是在磁盘里，这时候需要进行页的置换；      
4. 在swap_init进行之后，swap_init_ok为1，表明可以开始进行页的置换；      
5. 使用swap_in函数换入一个页，页的信息存放在传入的第三个参数，正确换入该函数的返回值是0；     
6. 用page_insert函数将线性地址与刚刚换入的页进行映射；     
7. 用swap_map_swappable函数将刚刚换入的页设为swappable。     
```

### 与标准答案的区别    
```
因为是根据注释中的步骤进行代码的编写，因此整体上与参考答案的区别不大。      
参考答案中有对各种错误情况进行处理（goto failed），而我一开始编写的时候没有注意对这些错误情况进行处理。    
后来加上了得到get_pte()后pte为NULL、pgdir_alloc_page()后page为NULL、swap_in()返回值不为0的情况进行了处理，     
这三种情况分别对应获取pte失败、分配页失败、换入页失败，这些失败将导致系统的错误崩溃退出。     
```

### 问答题
#### 1. 请描述页目录项（Pag Director Entry）和页表（Page Table Entry）中组成部分对ucore实现页替换算法的潜在用处。
```
根据PTE（PDE）的最后一位进行判断，如果是0，表明缺页，那么其前24位就是对应缺页在磁盘中的扇区号；如果是1，则正常映射(前20位为下一级地址的高20位)。     
```

#### 2. 如果ucore的缺页服务例程在执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？
```
产生页访问异常后，CPU在当前内核栈保存当前被打断的程序现场，即依次压入当前被打断程序使用的EFLAGS、CS、EIP、errorCode等；      
由于页访问异常的中断号是0xE，CPU把异常中断号0xE对应的中断服务例程的地址（vectors.S中的标号vector14处）加载到CS和EIP寄存器中；        
然后ucore开始处理异常中断；异常处理完成后，硬件需要恢复现场。       
但是缺页服务例程在执行过程中访问内存，又出现了页访问异常，次数系统会崩溃退出。     
```

## 练习2 补充完成基于FIFO的页面替换算法（需要编程）
完成vmm.c中的do_pgfault函数，并且在实现FIFO算法的swap_fifo.c中完成map_swappable和swap_out_vistim函数。
```
1. map_swappable()：将最近访问过的页插入到pra_list_head的头部后，表明这是最近使用的，越往前表明使用时间越近。     
2. swap_out_vistim()：
	(1)先得到最早进入队列的项，表明已经很长时间没有使用过了，根据该list的结构，可知最早进入的项在最末尾，也就是双向链表的head的前一项；     
	(2)用le2page函数从该项得到对应的页；     
	(3)从链表中删除该项，表明换出；      
	(4)设置传入的参数ptr_page为换出的页。     
```   

### 与标准答案的区别
```
因为是根据注释中的步骤进行代码的编写，因此整体上与参考答案的区别不大。      
参考答案中有对各种错误情况进行处理（assert），而我一开始编写的时候没有注意对这些错误情况进行处理。    
后来加上了两个错误判断：要换出的页last不能是head，而是head的前一项；从该项得到的页需要内容而不能是NULL。     
```     

### 问答题
#### 如果要在ucore上实现"extended clock页替换算法"请给你的设计方案，现有的swap_manager框架是否足以支持在ucore中实现此算法？如果是，请给你的设计方案。如果不是，请给出你的新的扩展和基此扩展的设计方案。并需要回答如下问题
1. 需要被换出的页的特征是什么？
2. 在ucore中如何判断具有这样特征的页？
3. 何时进行换入和换出操作？
```
可以。思路如下：     
在Page结构中的flags中设置一位访问位来表示此页当前是否被访问过。当该页被访问时，把访问位置1。      
当操作系统需要淘汰页时，对当前指针指向的页的访问位进行查询，如果访问位为0，则淘汰该页，如果该页被写过，则还要把它换出到硬盘上；       
如果访问位为1，则将该页表项的此位置0，继续访问下一个页。也就是跳过了访问位为1的页。      
1. Page结构中的flags中的访问位为0。     
2. 对Page结构中的flags对应的访问位进行判断。      
3. 换出：每隔1秒执行一次的积极换出、无法从物理内存页分配器获得空闲页时消极换出；     
    换入：发生缺页异常时。     
```

## 列出你认为本实验中重要的知识点，以及与对应的OS原理中的知识点。
```
1. 虚拟内存：逻辑地址内存空间大于实际的物理地址内存空间，其中一部分映射的页在物理内存中，一部分在磁盘外存中，通过虚拟页管理、缺页处理、页置换来实现。     
2. 局部性原理：fifo没有体现局部性原理，而时钟置换算法有所体现。     
3. 一些局部置换算法：fifo、时钟置换算法。页置换的策略选择。     
4. 缺页异常处理。主要是页的换入换出，需要用到页置换算法来实现。     
```

## 列出你认为OS原理中重要的知识点，但在实验中没有对应上
```
1. 一些局部置换算法：LRU、最不常用置换算法。     
2. 全局置换算法。     
```
